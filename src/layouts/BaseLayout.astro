---
import { SITE } from "../data/site";
import "../styles/global.css";

const canonical = SITE.domain.replace(/\/+$/, "");
const title = `Unidad Coronaria M√≥vil (UCM) 24/7 | Asistencia M√©dica y Rescate a Domicilio`;
const description = `Contrata tu plan con la Unidad Coronaria M√≥vil (UCM). Asistencia m√©dica 24/7, ambulancias equipadas y cobertura en Santiago y Valpara√≠so. Cotiza hoy.`;
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="robots" content="index,follow,max-image-preview:large" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <link rel="icon" type="image/png" href="/favicon.png" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Rescate M√©dico ‚Äì Planes UCM" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={`${canonical}/og-ucm.jpg`} />
    <meta property="og:locale" content="es_CL" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={`${canonical}/og-ucm.jpg`} />

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "MedicalBusiness",
        "name": "Planes UCM ‚Äì Rescate M√©dico",
        "description": description,
        "url": canonical,
        "image": `${canonical}/og-ucm.jpg`,
        "telephone": `+56${SITE.phone}`,
        "priceRange": "$$",
        "openingHours": "Mo-Su 00:00-23:59",
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": -33.45694,
          "longitude": -70.64827
        },
        "areaServed": [
          { "@type": "Place", "name": "Regi√≥n Metropolitana de Santiago" },
          { "@type": "Place", "name": "Regi√≥n de Valpara√≠so" }
        ],
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Santiago",
          "addressRegion": "Regi√≥n Metropolitana",
          "addressCountry": "CL"
        },
        "hasOfferCatalog": {
          "@type": "OfferCatalog",
          "name": "Planes UCM",
          "itemListElement": [
            { "@type": "Offer", "name": "Plan Familiar", "category": "Familiar", "priceCurrency": "CLP" },
            { "@type": "Offer", "name": "Plan Empresas", "category": "Empresas", "priceCurrency": "CLP" }
          ]
        }
      })}
    </script>

     <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17545387254"></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    gtag('js', new Date());
    gtag('config', 'AW-17545387254');
  </script>

    <!-- Script de tracking de CTA -->
    <script defer>
      window.addEventListener("load", function () {
        // console.log("üü° Esperando que gtag est√© disponible...");

        let attempts = 0;
        const maxAttempts = 20;
        const delay = 300;

        const interval = setInterval(() => {
          attempts++;

          const hasGtag = typeof gtag === "function";
          const hasScript = !!document.querySelector('script[src*="googletagmanager.com/gtag/js"]');

          // console.log(`[debug] Intento ${attempts}/${maxAttempts}`);
          // console.log(`[debug] gtag disponible:`, hasGtag);
          // console.log(`[debug] Script presente:`, hasScript);

          if (hasGtag) {
            clearInterval(interval);
            // console.log("‚úÖ gtag est√° listo, activando tracking de botones");

            document.querySelectorAll("[data-cta]")?.forEach((el) => {
              el.addEventListener("click", () => {
                const id = el.getAttribute("data-cta") || "cta";
                // console.log(`[gtag] Click detectado: ${id}`);

                gtag("event", "cta_click", { id });

                if (id.includes("whatsapp")) {
                  gtag("event", "click_whatsapp", { id });
                  gtag("event", "conversion", {
                    send_to: "AW-17545387254/WndcCM6r-LkbEPa5pa5B",
                    value: 1.0,
                    currency: "CLP"
                  });
                }

                if (id.includes("llamar") || id.includes("call")) {
                  gtag("event", "click_tel", { id });
                  gtag("event", "conversion", {
                    send_to: "AW-17545387254/VBFyCMav-LkbEPa5pa5B",
                    value: 1.0,
                    currency: "CLP"
                  });
                }
              });
            });
          }

          if (attempts >= maxAttempts) {
            clearInterval(interval);
            // console.warn("‚õî No se pudo detectar gtag despu√©s de varios intentos.");
            // console.warn("Sospecha: ‚ö†Ô∏è problema con el script de Google o conflicto con Astro.");
          }
        }, delay);
      });
    </script>
  </head>

  <body class="bg-slate-50 text-slate-800 antialiased">
    <slot />
  </body>
</html>
